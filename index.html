<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>미니게임 — 클릭 서클 (Click the Circle)</title>
  <style>
    :root{--bg:#0f172a;--card:#0b1220;--accent:#7c3aed;--muted:#94a3b8;--glass: rgba(255,255,255,0.04)}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", "Apple SD Gothic Neo", "Malgun Gothic", sans-serif;background:linear-gradient(180deg,#07102a 0%, #071a2f 100%);color:#e6eef8}
    .wrap{max-width:980px;margin:28px auto;padding:20px}
    header{display:flex;gap:16px;align-items:center}
    h1{margin:0;font-size:20px}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 6px 24px rgba(2,6,23,0.6);}
    .top-row{display:flex;gap:12px;align-items:center}
    .panel{padding:12px;border-radius:10px;background:var(--glass);min-width:120px}
    #game-area{margin-top:14px;display:grid;grid-template-columns:1fr 280px;gap:14px}
    #canvas-wrap{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:12px}
    canvas{display:block;width:100%;height:480px;border-radius:8px;background:linear-gradient(180deg,#082139 0%, #031022 100%);cursor:crosshair}
    .sidebar{display:flex;flex-direction:column;gap:10px}
    button{background:var(--accent);color:white;padding:8px 10px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .info-row{display:flex;gap:8px;align-items:center;justify-content:space-between}
    .big{font-size:22px;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .footer{margin-top:12px;color:var(--muted);font-size:13px}
    .controls{display:flex;flex-direction:column;gap:8px}
    label{font-size:13px;color:var(--muted)}
    input[type=range]{width:100%}
    .center{display:flex;flex-direction:column;align-items:center;justify-content:center}
    @media (max-width:900px){#game-area{grid-template-columns:1fr;}.sidebar{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <header class="top-row">
      <div>
        <h1>간단한 미니게임 — 클릭 서클</h1>
        <div class="small">나타나는 원을 클릭해서 점수를 올리세요. 시간 내에 최대한 많이 클릭하세요!</div>
      </div>
    </header>

    <main class="card" style="margin-top:12px">
      <div id="game-area">
        <div id="canvas-wrap">
          <canvas id="gameCanvas" width="800" height="480"></canvas>
          <div class="footer">좌클릭으로 원을 클릭하세요. 모바일에서는 터치하세요.</div>
        </div>

        <aside class="sidebar">
          <div class="panel">
            <div class="info-row">
              <div>
                <div class="small">점수</div>
                <div id="score" class="big">0</div>
              </div>
              <div>
                <div class="small">시간</div>
                <div id="time" class="big">30</div>
              </div>
            </div>
            <div style="margin-top:10px" class="info-row">
              <div>
                <div class="small">최고점수</div>
                <div id="highscore" class="big">0</div>
              </div>
              <div class="center">
                <button id="startBtn">게임 시작</button>
                <button id="pauseBtn" class="secondary" style="margin-top:8px">일시정지</button>
              </div>
            </div>
          </div>

          <div class="panel controls">
            <label>난이도: <span id="difficultyLabel">보통</span></label>
            <input id="difficulty" type="range" min="0" max="2" value="1">
            <label>원 크기 범위: <span id="sizeLabel">30 - 60</span> px</label>
            <input id="sizeRange" type="range" min="10" max="80" value="45">
            <label>게임 시간: <span id="durationLabel">30</span>초</label>
            <input id="durationRange" type="range" min="10" max="120" value="30">
            <button id="resetBtn" class="secondary">리셋 (점수, 설정 초기화)</button>
          </div>

          <div class="panel small">
            팁: 난이도를 올리면 원이 더 자주 나타납니다. 휴대전화에선 터치로 진행하세요.
          </div>
        </aside>
      </div>
    </main>
  </div>

  <script>
    /* --- 게임 설정 및 상태 --- */
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const timeEl = document.getElementById('time');
    const highEl = document.getElementById('highscore');
    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const difficulty = document.getElementById('difficulty');
    const difficultyLabel = document.getElementById('difficultyLabel');
    const sizeRange = document.getElementById('sizeRange');
    const sizeLabel = document.getElementById('sizeLabel');
    const durationRange = document.getElementById('durationRange');
    const durationLabel = document.getElementById('durationLabel');
    const resetBtn = document.getElementById('resetBtn');

    let state = {
      running: false,
      paused: false,
      score: 0,
      timeLeft: parseInt(durationRange.value, 10),
      duration: parseInt(durationRange.value,10),
      highscore: Number(localStorage.getItem('clickCircleHigh') || 0),
      targets: [],
      spawnTimer: 0,
      spawnInterval: 900, // ms base
      lastTime: null
    };

    highEl.textContent = state.highscore;
    timeEl.textContent = state.timeLeft;
    sizeLabel.textContent = `${Math.max(10,sizeRange.value-15)} - ${sizeRange.value}`;
    durationLabel.textContent = durationRange.value;

    /* --- 유틸 --- */
    function rand(min,max){return Math.random()*(max-min)+min}

    /* --- 타겟(원) 생성 --- */
    function spawnTarget(){
      const maxR = Number(sizeRange.value);
      const minR = Math.max(8, maxR - 30);
      const r = Math.round(rand(minR, maxR));
      const x = rand(r, canvas.width - r);
      const y = rand(r, canvas.height - r);
      const colorHue = Math.round(rand(0, 360));
      const lifespan = 1200 + rand(0, 1600); // ms
      state.targets.push({x,y,r,colorHue,spawn:performance.now(),life:lifespan});
    }

    /* --- 입력 처리 (클릭/터치) --- */
    function handlePointer(e){
      if(!state.running || state.paused) return;
      const rect = canvas.getBoundingClientRect();
      const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
      const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
      const x = (clientX - rect.left) * (canvas.width / rect.width);
      const y = (clientY - rect.top) * (canvas.height / rect.height);

      // 뒤에서 순회해서 클릭된 가장 위(최근 생성)를 우선
      for(let i = state.targets.length -1; i>=0; i--){
        const t = state.targets[i];
        const dx = x - t.x, dy = y - t.y;
        if(dx*dx + dy*dy <= t.r * t.r){
          // 클릭 성공
          state.score += Math.round(10 + (60 - t.r));
          state.targets.splice(i,1);
          scoreEl.textContent = state.score;
          // 클릭 효과
          pulseEffect(t.x,t.y);
          return;
        }
      }
      // 빈칸 클릭은 페널티 없음 (원하면 여기에 -점수 추가 가능)
    }

    /* --- 클릭 시 시각 효과 --- */
    let pulses = [];
    function pulseEffect(x,y){
      pulses.push({x,y, t:0});
    }

    /* --- 게임 루프 --- */
    function update(now){
      if(!state.lastTime) state.lastTime = now;
      const dt = now - state.lastTime;
      state.lastTime = now;

      if(state.running && !state.paused){
        // 시간 감소
        state.timeLeft -= dt/1000;
        if(state.timeLeft <= 0){
          state.timeLeft = 0; endGame();
        }
        timeEl.textContent = Math.ceil(state.timeLeft);

        // spawn logic: difficulty modifies spawnInterval
        const diff = Number(difficulty.value);
        const base = 1200 - diff*350; // 1200, 850, 500
        const randomFactor = rand(0, 300);
        state.spawnInterval = Math.max(300, base - randomFactor + (50 - Number(sizeRange.value)) * -6);

        state.spawnTimer += dt;
        if(state.spawnTimer >= state.spawnInterval){
          spawnTarget();
          state.spawnTimer = 0;
        }

        // targets lifespan
        state.targets = state.targets.filter(t=> now - t.spawn < t.life);

        // pulses update
        pulses = pulses.map(p=> ({...p, t: p.t + dt})).filter(p=> p.t < 400);
      }

      render();
      requestAnimationFrame(update);
    }

    /* --- 그리기 --- */
    function render(){
      // 캔버스 클리어
      ctx.clearRect(0,0,canvas.width,canvas.height);

      // 배경 그라디언트 라이트 효과
      const g = ctx.createLinearGradient(0,0,0,canvas.height);
      g.addColorStop(0,'rgba(255,255,255,0.02)');
      g.addColorStop(1,'rgba(0,0,0,0.12)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,canvas.width,canvas.height);

      // targets
      for(const t of state.targets){
        const age = performance.now() - t.spawn;
        const alpha = 1 - Math.min(1, age / t.life);
        // ring
        ctx.beginPath();
        ctx.arc(t.x, t.y, t.r + 6, 0, Math.PI*2);
        ctx.fillStyle = `hsla(${t.colorHue},80%,60%,${0.04 * alpha})`;
        ctx.fill();

        // circle
        ctx.beginPath();
        ctx.arc(t.x, t.y, t.r, 0, Math.PI*2);
        ctx.fillStyle = `hsl(${t.colorHue}, 85%, 55%)`;
        ctx.fill();
        // inner shine
        ctx.beginPath();
        ctx.arc(t.x - t.r*0.25, t.y - t.r*0.25, t.r*0.35, 0, Math.PI*2);
        ctx.fillStyle = `rgba(255,255,255, ${0.15 * alpha})`;
        ctx.fill();
      }

      // pulses
      for(const p of pulses){
        const prog = p.t / 400;
        const r = prog * 80;
        ctx.beginPath();
        ctx.arc(p.x, p.y, r, 0, Math.PI*2);
        ctx.strokeStyle = `rgba(255,255,255, ${0.18 * (1-prog)})`;
        ctx.lineWidth = 2;
        ctx.stroke();
      }

      // HUD: small hint
      ctx.fillStyle = 'rgba(255,255,255,0.04)';
      ctx.fillRect(8,8,220,34);
      ctx.fillStyle = '#dbeafe';
      ctx.font = '14px system-ui';
      ctx.fillText('클릭해서 점수 얻기 • 남은 원 개수: ' + state.targets.length, 16, 30);
    }

    /* --- 게임 제어 --- */
    function startGame(){
      state.running = true;
      state.paused = false;
      state.score = 0;
      state.targets = [];
      state.spawnTimer = 0;
      state.duration = Number(durationRange.value);
      state.timeLeft = state.duration;
      scoreEl.textContent = 0;
      timeEl.textContent = state.timeLeft;
      startBtn.textContent = '재시작';
      pauseBtn.textContent = '일시정지';
      state.lastTime = null;
    }

    function pauseGame(){
      if(!state.running) return;
      state.paused = !state.paused;
      pauseBtn.textContent = state.paused ? '계속' : '일시정지';
    }

    function endGame(){
      state.running = false;
      state.targets = [];
      // 최고점수 저장
      if(state.score > state.highscore){
        state.highscore = state.score;
        localStorage.setItem('clickCircleHigh', String(state.highscore));
        highEl.textContent = state.highscore;
      }
      // 결과 표시 (간단한 애니메이션 대신 alert)
      setTimeout(()=>{
        alert('게임 종료! 점수: ' + state.score + '\n최고점수: ' + state.highscore);
      }, 80);
    }

    /* --- 이벤트 바인딩 --- */
    canvas.addEventListener('mousedown', handlePointer);
    canvas.addEventListener('touchstart', function(e){ e.preventDefault(); handlePointer(e); }, {passive:false});

    startBtn.addEventListener('click', ()=> startGame());
    pauseBtn.addEventListener('click', ()=> pauseGame());

    difficulty.addEventListener('input', ()=>{
      const v = Number(difficulty.value);
      const label = ['쉬움','보통','어려움'][v] || '보통';
      difficultyLabel.textContent = label;
    });

    sizeRange.addEventListener('input', ()=>{
      sizeLabel.textContent = `${Math.max(10,sizeRange.value-15)} - ${sizeRange.value}`;
    });

    durationRange.addEventListener('input', ()=>{
      durationLabel.textContent = durationRange.value;
    });

    resetBtn.addEventListener('click', ()=>{
      localStorage.removeItem('clickCircleHigh');
      state.highscore = 0; highEl.textContent = 0;
      difficulty.value = 1; difficultyLabel.textContent = '보통';
      sizeRange.value = 45; sizeLabel.textContent = '30 - 45';
      durationRange.value = 30; durationLabel.textContent = '30';
      state.score = 0; scoreEl.textContent = 0;
      state.running = false; state.paused = false; startBtn.textContent = '게임 시작'; pauseBtn.textContent = '일시정지';
    });

    // 캔버스 크기 보정 (CSS responsive와 캔버스 내부 픽셀 해상도 동기화)
    function fitCanvas(){
      const ratio = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(300, Math.floor(rect.width * ratio));
      canvas.height = Math.max(200, Math.floor(rect.height * ratio));
    }
    window.addEventListener('resize', ()=> fitCanvas());
    fitCanvas();

    // 메인 루프 시작
    requestAnimationFrame(update);
  </script>
</body>
</html>
